{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">Bienvenue, {{ user_first_name }}</h1>
    
    <!-- Random quote with improved styling -->
    <div class="row mt-2 mb-4">
        <div class="col-12">
            <div class="card shadow" style="border-radius: 10px; border-left: 4px solid #4e73df;">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-center">
                        <div class="quote-container" style="max-width: 600px;">
                            <i class="material-icons-outlined" style="color: #4e73df; font-size: 24px; margin-bottom: 10px;">format_quote</i>
                            <p class="mb-2" style="font-size: 1.2rem; font-style: italic; color: #5a5c69; line-height: 1.6;">
                                "{{ quote.text }}"
                            </p>
                            <p class="text-right mb-0" style="font-weight: 600; color: #4e73df;">- {{ quote.author }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 border-left-primary shadow py-2" style="border-left: 4px solid #4e73df; border-radius: 10px;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Projets Actifs</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_projects }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="material-icons-outlined text-gray-300" style="font-size: 2rem;">folder</i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 border-left-success shadow py-2" style="border-left: 4px solid #1cc88a; border-radius: 10px;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Tâches Terminées</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ task_stats.DONE }} / {{ task_stats.TODO + task_stats.IN_PROGRESS + task_stats.REVIEW + task_stats.DONE }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="material-icons-outlined text-gray-300" style="font-size: 2rem;">check_circle</i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 border-left-info shadow py-2" style="border-left: 4px solid #36b9cc; border-radius: 10px;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Taux d'Achèvement</div>
                            <div class="row no-gutters align-items-center">
                                <div class="col-auto">
                                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ completion_percentage }}%</div>
                                </div>
                                <div class="col">
                                    <div class="progress progress-sm mr-2">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ completion_percentage }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="material-icons-outlined text-gray-300" style="font-size: 2rem;">trending_up</i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 border-left-warning shadow py-2" style="border-left: 4px solid #f6c23e; border-radius: 10px;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Tâches Prioritaires</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ priority_stats.high }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="material-icons-outlined text-gray-300" style="font-size: 2rem;">priority_high</i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100" style="border-radius: 10px;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="background-color: #f8f9fc; border-radius: 10px 10px 0 0;">
                    <h6 class="m-0 font-weight-bold text-primary">Répartition des Tâches</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:250px;">
                        <canvas id="taskStatusChart"></canvas>
                    </div>
                </div>
                <div class="card-footer small text-muted" style="background-color: #f8f9fc; border-radius: 0 0 10px 10px;">
                    Mise à jour aujourd'hui
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow h-100" style="border-radius: 10px;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="background-color: #f8f9fc; border-radius: 10px 10px 0 0;">
                    <h6 class="m-0 font-weight-bold text-primary">Projets les Plus Actifs</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:250px;">
                        <canvas id="projectActivityChart"></canvas>
                    </div>
                </div>
                <div class="card-footer small text-muted" style="background-color: #f8f9fc; border-radius: 0 0 10px 10px;">
                    Basé sur le nombre de tâches
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100" style="border-radius: 10px;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="background-color: #f8f9fc; border-radius: 10px 10px 0 0;">
                    <h6 class="m-0 font-weight-bold text-primary">Répartition par Priorité</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:250px;">
                        <canvas id="priorityChart"></canvas>
                    </div>
                </div>
                <div class="card-footer small text-muted" style="background-color: #f8f9fc; border-radius: 0 0 10px 10px;">
                    Distribution des tâches par niveau de priorité
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow h-100" style="border-radius: 10px;">
                <div class="card-header py-3" style="background-color: #f8f9fc; border-radius: 10px 10px 0 0;">
                    <h6 class="m-0 font-weight-bold text-primary">Tâches Récentes</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th>Priorité</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in recent_tasks %}
                                <tr>
                                    <td>{{ task.title }}</td>
                                    <td>
                                        {% if task.priority == 'high' %}
                                            <span class="badge bg-danger">Haute</span>
                                        {% elif task.priority == 'medium' %}
                                            <span class="badge bg-warning">Moyenne</span>
                                        {% else %}
                                            <span class="badge bg-success">Basse</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if task.status == 'DONE' %}
                                            <span class="badge bg-success">Terminée</span>
                                        {% elif task.status == 'IN_PROGRESS' %}
                                            <span class="badge bg-primary">En cours</span>
                                        {% elif task.status == 'REVIEW' %}
                                            <span class="badge bg-info">En révision</span>
                                        {% else %}
                                            <span class="badge bg-secondary">À faire</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center">Aucune tâche récente</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer small text-muted" style="background-color: #f8f9fc; border-radius: 0 0 10px 10px;">
                    Tâches récemment assignées
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chatbot Button -->
<div class="chatbot-button-container">
    <button id="chatbotButton" class="btn btn-primary rounded-circle chatbot-btn shadow-lg">
        <i class="material-icons-outlined">smart_toy</i>
    </button>
</div>

<!-- Chatbot Modal -->
<div class="modal fade" id="chatbotModal" tabindex="-1" aria-labelledby="chatbotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chatbotModalLabel">Assistant IA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="chatbot-container">
                    <div class="chatbot-messages" id="chatbotMessages">
                        <div class="message bot-message">
                            <div class="message-content">
                                <p>Bonjour ! Je suis votre assistant IA. Je peux vous aider à :</p>
                                <ul>
                                    <li>Générer des tâches pour votre projet</li>
                                    <li>Créer un cahier des charges</li>
                                    <li>Organiser votre projet</li>
                                </ul>
                                <p>Comment puis-je vous aider aujourd'hui ?</p>
                            </div>
                        </div>
                    </div>
                    <div class="chatbot-input">
                        <form id="chatbotForm" class="d-flex">
                            <select id="projectSelector" class="form-select me-2" style="max-width: 200px;">
                                <option value="">Sélectionner un projet</option>
                                {% for project in user_projects %}
                                <option value="{{ project.project_id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" id="userMessage" class="form-control me-2" placeholder="Tapez votre message ici..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="material-icons-outlined">send</i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Task Status Chart
    var ctxTaskStatus = document.getElementById('taskStatusChart').getContext('2d');
    var taskStatusChart = new Chart(ctxTaskStatus, {
        type: 'doughnut',
        data: {
            labels: ['À faire', 'En cours', 'En révision', 'Terminées'],
            datasets: [{
                data: [{{ task_stats.TODO }}, {{ task_stats.IN_PROGRESS }}, {{ task_stats.REVIEW }}, {{ task_stats.DONE }}],
                backgroundColor: ['#e74a3b', '#4e73df', '#36b9cc', '#1cc88a'],
                hoverBackgroundColor: ['#be3c2e', '#3a57ad', '#2a909e', '#17a673'],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            cutout: '70%',
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        return data.labels[tooltipItem.index] + ': ' + data.datasets[0].data[tooltipItem.index];
                    }
                }
            }
        }
    });

    // Project Activity Chart
    var ctxProjectActivity = document.getElementById('projectActivityChart').getContext('2d');
    var projectLabels = [{% for project in active_projects %}'{{ project.name }}',{% endfor %}];
    var projectData = [{% for project in active_projects %}{{ project.task_count }},{% endfor %}];
    
    var projectActivityChart = new Chart(ctxProjectActivity, {
        type: 'bar',
        data: {
            labels: projectLabels,
            datasets: [{
                label: 'Nombre de tâches',
                data: projectData,
                backgroundColor: '#4e73df',
                borderColor: '#4e73df',
                borderWidth: 1
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });

    // Priority Chart
    var ctxPriority = document.getElementById('priorityChart').getContext('2d');
    var priorityChart = new Chart(ctxPriority, {
        type: 'pie',
        data: {
            labels: ['Basse', 'Moyenne', 'Haute'],
            datasets: [{
                data: [{{ priority_stats.low }}, {{ priority_stats.medium }}, {{ priority_stats.high }}],
                backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
                hoverBackgroundColor: ['#17a673', '#dda20a', '#be3c2e'],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            tooltips: {
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                displayColors: false,
                caretPadding: 10,
            }
        }
    });
    
    // Chatbot functionality
    document.addEventListener('DOMContentLoaded', function() {
        const chatbotButton = document.getElementById('chatbotButton');
        const chatbotForm = document.getElementById('chatbotForm');
        const chatbotMessages = document.getElementById('chatbotMessages');
        const userMessageInput = document.getElementById('userMessage');
        const projectSelector = document.getElementById('projectSelector');
        
        if (chatbotButton) {
            chatbotButton.addEventListener('click', function() {
                const chatbotModal = new bootstrap.Modal(document.getElementById('chatbotModal'));
                chatbotModal.show();
            });
        }
        
        if (chatbotForm) {
            chatbotForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = userMessageInput.value.trim();
                const projectId = projectSelector.value;
                
                if (message) {
                    // Add user message to chat
                    addMessage(message, 'user');
                    
                    // Clear input
                    userMessageInput.value = '';
                    
                    // Show loading indicator
                    addMessage('Je réfléchis...', 'bot', true);
                    
                    // Send to backend
                    fetch('/chatbot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            project_id: projectId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Remove loading indicator
                        removeLoadingMessage();
                        
                        // Add response to chat
                        addMessage(data.response, 'bot');
                        
                        // If there are tasks to add
                        if (data.tasks && data.tasks.length > 0) {
                            addMessage('Je peux ajouter ces tâches à votre projet. Souhaitez-vous les ajouter maintenant ?', 'bot');
                            addTaskConfirmation(data.tasks, projectId);
                        }
                        
                        // If there's a specification
                        if (data.specification) {
                            addMessage('J\'ai créé un cahier des charges. Souhaitez-vous l\'enregistrer ?', 'bot');
                            addSpecConfirmation(data.specification, projectId);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        removeLoadingMessage();
                        addMessage('Désolé, j\'ai rencontré une erreur. Veuillez réessayer.', 'bot');
                    });
                }
            });
        }
        
        function addMessage(text, sender, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            if (isLoading) {
                messageDiv.className += ' loading-message';
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (isLoading) {
                messageContent.innerHTML = `<p>${text} <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></p>`;
            } else {
                messageContent.innerHTML = `<p>${text}</p>`;
            }
            
            messageDiv.appendChild(messageContent);
            chatbotMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        
        function removeLoadingMessage() {
            const loadingMessage = chatbotMessages.querySelector('.loading-message');
            if (loadingMessage) {
                chatbotMessages.removeChild(loadingMessage);
            }
        }
        
        function addTaskConfirmation(tasks, projectId) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            let tasksHtml = '<ul class="task-list">';
            tasks.forEach(task => {
                tasksHtml += `<li>${task.title} (${task.priority})</li>`;
            });
            tasksHtml += '</ul>';
            
            const confirmButton = document.createElement('button');
            confirmButton.className = 'btn btn-sm btn-success me-2';
            confirmButton.textContent = 'Oui, ajouter ces tâches';
            confirmButton.onclick = function() {
                addTasks(tasks, projectId);
            };
            
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-sm btn-outline-secondary';
            cancelButton.textContent = 'Non, merci';
            
            messageContent.innerHTML = tasksHtml;
            messageContent.appendChild(confirmButton);
            messageContent.appendChild(cancelButton);
            
            messageDiv.appendChild(messageContent);
            chatbotMessages.appendChild(messageDiv);
            
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        
        function addSpecConfirmation(specification, projectId) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const confirmButton = document.createElement('button');
            confirmButton.className = 'btn btn-sm btn-success me-2';
            confirmButton.textContent = 'Oui, enregistrer';
            confirmButton.onclick = function() {
                saveSpecification(specification, projectId);
            };
            
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-sm btn-outline-secondary';
            cancelButton.textContent = 'Non, merci';
            
            messageContent.innerHTML = `<p><strong>Titre:</strong> ${specification.title}</p>`;
            messageContent.appendChild(confirmButton);
            messageContent.appendChild(cancelButton);
            
            messageDiv.appendChild(messageContent);
            chatbotMessages.appendChild(messageDiv);
            
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        
        function addTasks(tasks, projectId) {
            fetch('/chatbot/add_tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tasks: tasks,
                    project_id: projectId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage('Tâches ajoutées avec succès !', 'bot');
                } else {
                    addMessage(`Erreur: ${data.message}`, 'bot');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('Désolé, je n\'ai pas pu ajouter les tâches.', 'bot');
            });
        }
        
        function saveSpecification(specification, projectId) {
            fetch('/chatbot/save_specification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    specification: specification,
                    project_id: projectId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage(`Cahier des charges enregistré avec succès ! <a href="/specification/${data.specification_id}" target="_blank">Voir le cahier des charges</a>`, 'bot');
                } else {
                    addMessage(`Erreur: ${data.message}`, 'bot');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('Désolé, je n\'ai pas pu enregistrer le cahier des charges.', 'bot');
            });
        }
    });
</script>

<style>
    .chatbot-button-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
    }
    
    .chatbot-btn {
        width: 60px;
        height: 60px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }
    
    .chatbot-btn i {
        font-size: 28px;
    }
    
    .chatbot-btn:hover {
        transform: scale(1.1);
    }
    
    .chatbot-container {
        display: flex;
        flex-direction: column;
        height: 60vh;
    }
    
    .chatbot-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f8f9fc;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
    }
    
    .user-message {
        justify-content: flex-end;
    }
    
    .message-content {
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 80%;
    }
    
    .user-message .message-content {
        background-color: #4e73df;
        color: white;
    }
    
    .bot-message .message-content {
        background-color: #e9ecef;
        color: #444;
    }
    
    .chatbot-input {
        padding: 10px 0;
    }
    
    .loading-dots span {
        animation: loading 1.4s infinite;
        animation-fill-mode: both;
    }
    
    .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes loading {
        0% { opacity: 0.2; }
        20% { opacity: 1; }
        100% { opacity: 0.2; }
    }
</style>
{% endblock %}
