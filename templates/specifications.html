{% extends "base.html" %}

{% block title %}Cahier des Charges{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mt-4">Cahier des Charges</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSpecificationModal">
            <i class="material-icons-outlined">add</i> Nouveau
        </button>
    </div>

    <!-- Project Filter -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filtrer par projet</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <select id="projectFilter" class="form-select">
                        <option value="all">Tous les projets</option>
                        {% for project in projects %}
                            <option value="{{ project.project_id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Specifications List -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Liste des cahiers des charges</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Projet</th>
                            <th>Date de création</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="specificationsTable">
                        {% if specifications %}
                            {% for spec in specifications %}
                            <tr data-project-id="{{ spec.project_id }}">
                                <td>{{ spec.title }}</td>
                                <td>{{ spec.project_name }}</td>
                                <td>{{ spec.created_at.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    {% if spec.status == 'draft' %}
                                    <span class="badge bg-secondary">Brouillon</span>
                                    {% elif spec.status == 'review' %}
                                    <span class="badge bg-primary">En révision</span>
                                    {% elif spec.status == 'approved' %}
                                    <span class="badge bg-success">Approuvé</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('view_specification', specification_id=spec.specification_id) }}" class="btn btn-sm btn-info">
                                        <i class="material-icons-outlined" style="font-size: 16px;">visibility</i>
                                    </a>
                                    <button class="btn btn-sm btn-danger delete-spec-btn" data-spec-id="{{ spec.specification_id }}">
                                        <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center">Aucun cahier des charges trouvé</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- New Specification Modal -->
<div class="modal fade" id="newSpecificationModal" tabindex="-1" aria-labelledby="newSpecificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSpecificationModalLabel">Nouveau Cahier des Charges</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="specificationForm" action="{{ url_for('save_specification') }}" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="specTitle" class="form-label">Titre</label>
                        <input type="text" class="form-control" id="specTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="specProject" class="form-label">Projet</label>
                        <select class="form-select" id="specProject" name="project_id" required>
                            <option value="" selected disabled>Sélectionnez un projet</option>
                            {% for project in projects %}
                                <option value="{{ project.project_id }}" 
                                    data-name="{{ project.name }}" 
                                    data-description="{{ project.description }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="specDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="specDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <!-- Auto-generate section -->
                    <div class="mb-4 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="m-0">Génération automatique</h5>
                            <button type="button" id="generateSpecsBtn" class="btn btn-sm btn-primary">
                                <i class="material-icons-outlined" style="font-size: 16px; vertical-align: middle;">auto_awesome</i>
                                Générer le contenu
                            </button>
                        </div>
                        <div class="text-muted small">
                            Cette fonctionnalité génère automatiquement les sections du cahier des charges en se basant sur le titre et la description du projet. Vous pouvez modifier le contenu généré selon vos besoins.
                        </div>
                        <div id="generationProgress" class="progress mt-2" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="specObjectives" class="form-label">Objectifs</label>
                        <textarea class="form-control" id="specObjectives" name="objectives" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="specRequirements" class="form-label">Exigences fonctionnelles</label>
                        <textarea class="form-control" id="specRequirements" name="requirements" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="specConstraints" class="form-label">Contraintes techniques</label>
                        <textarea class="form-control" id="specConstraints" name="constraints" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="specDeliverables" class="form-label">Livrables</label>
                        <textarea class="form-control" id="specDeliverables" name="deliverables" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="specTimeline" class="form-label">Calendrier</label>
                        <textarea class="form-control" id="specTimeline" name="timeline" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="specStatus" class="form-label">Statut</label>
                        <select class="form-select" id="specStatus" name="status">
                            <option value="draft">Brouillon</option>
                            <option value="review">En révision</option>
                            <option value="approved">Approuvé</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="specFile" class="form-label">Joindre un document</label>
                        <input class="form-control" type="file" id="specFile" name="document">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveSpecification">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle project filter change
        document.getElementById('projectFilter').addEventListener('change', function() {
            const selectedProjectId = this.value;
            const tableRows = document.querySelectorAll('#specificationsTable tr');
            
            // Show/hide rows based on selected project
            tableRows.forEach(row => {
                // Skip header row or rows with no data attributes
                if (!row.dataset.projectId) return;
                
                if (selectedProjectId === 'all' || row.dataset.projectId === selectedProjectId) {
                    row.style.display = '';  // Show row
                } else {
                    row.style.display = 'none';  // Hide row
                }
            });
            
            // Show message if no specifications are visible
            const visibleRows = document.querySelectorAll('#specificationsTable tr:not([style="display: none;"])');
            const noSpecsRow = document.getElementById('noSpecificationsRow');
            
            if (visibleRows.length === 0 && !noSpecsRow) {
                const tbody = document.getElementById('specificationsTable');
                const newRow = document.createElement('tr');
                newRow.id = 'noSpecificationsRow';
                newRow.innerHTML = `<td colspan="5" class="text-center">Aucun cahier des charges trouvé pour ce projet</td>`;
                tbody.appendChild(newRow);
            } else if (visibleRows.length > 0 && noSpecsRow) {
                noSpecsRow.remove();
            }
        });
        
        // Project selection handling
        document.getElementById('specProject').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const projectName = selectedOption.getAttribute('data-name');
            const projectDescription = selectedOption.getAttribute('data-description') || '';
            
            // Auto-fill title if empty
            const titleField = document.getElementById('specTitle');
            if (!titleField.value) {
                titleField.value = `Cahier des charges - ${projectName}`;
            }
            
            // Auto-fill description if empty
            const descField = document.getElementById('specDescription');
            if (!descField.value && projectDescription) {
                descField.value = projectDescription;
            }
        });
        
        // Auto-generation button handling
        document.getElementById('generateSpecsBtn').addEventListener('click', function() {
            // Get project data
            const projectSelect = document.getElementById('specProject');
            const selectedOption = projectSelect.options[projectSelect.selectedIndex];
            
            if (!selectedOption || selectedOption.value === '') {
                alert('Veuillez d\'abord sélectionner un projet.');
                return;
            }
            
            const projectName = selectedOption.getAttribute('data-name');
            const projectDescription = selectedOption.getAttribute('data-description') || '';
            const projectTitle = document.getElementById('specTitle').value || `Cahier des charges - ${projectName}`;
            const userDescription = document.getElementById('specDescription').value || projectDescription;
            
            // Show progress indicator
            document.getElementById('generationProgress').style.display = 'flex';
            
            // Generate content with improved keywords extraction and analysis
            setTimeout(() => {
                generateSpecifications(projectName, userDescription);
                document.getElementById('generationProgress').style.display = 'none';
                
                // Show success message
                const modalBody = document.querySelector('.modal-body');
                const alertEl = document.createElement('div');
                alertEl.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertEl.innerHTML = `
                    <strong>Succès!</strong> Contenu généré automatiquement. N'hésitez pas à modifier le contenu selon vos besoins.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                modalBody.insertBefore(alertEl, document.getElementById('specificationForm'));
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    alertEl.classList.remove('show');
                    setTimeout(() => alertEl.remove(), 150);
                }, 5000);
            }, 1500);
        });
        
        function generateSpecifications(projectName, description) {
            // Generate objectives with improved context-awareness
            const objectives = generateObjectives(projectName, description);
            document.getElementById('specObjectives').value = objectives;
            
            // Generate requirements with better pattern recognition
            const requirements = generateRequirements(projectName, description);
            document.getElementById('specRequirements').value = requirements;
            
            // Generate constraints with industry-standard considerations
            const constraints = generateConstraints(projectName, description);
            document.getElementById('specConstraints').value = constraints;
            
            // Generate deliverables with project-specific items
            const deliverables = generateDeliverables(projectName, description);
            document.getElementById('specDeliverables').value = deliverables;
            
            // Generate timeline with more realistic projections
            const timeline = generateTimeline(projectName, description);
            document.getElementById('specTimeline').value = timeline;
        }
        
        function generateObjectives(projectName, description) {
            // Start with standard objectives
            const objectives = [
                `Objectif principal: Développer ${projectName} conformément aux spécifications définies ci-dessous`,
                "Objectifs secondaires:",
                "1. Assurer une implémentation de qualité et conforme aux exigences"
            ];
            
            // Analyze the description for context-specific objectives
            if (description.toLowerCase().includes('web') || description.toLowerCase().includes('site') || 
                description.toLowerCase().includes('application') || description.toLowerCase().includes('app')) {
                objectives.push("2. Créer une solution numérique intuitive et accessible à tous les utilisateurs cibles");
            } else if (description.toLowerCase().includes('document') || description.toLowerCase().includes('rapport')) {
                objectives.push("2. Produire une documentation claire et exhaustive répondant aux besoins exprimés");
            } else {
                objectives.push("2. Livrer un produit final conforme aux attentes et aux standards de l'industrie");
            }
            
            // Add custom objectives based on keywords in description
            if (description.toLowerCase().includes('interface') || description.toLowerCase().includes('ui') || 
                description.toLowerCase().includes('ux')) {
                objectives.push("3. Concevoir une interface utilisateur intuitive et ergonomique");
                objectives.push("4. Optimiser l'expérience utilisateur à travers des parcours fluides et cohérents");
            }
            
            if (description.toLowerCase().includes('performance') || description.toLowerCase().includes('rapide') || 
                description.toLowerCase().includes('vitesse')) {
                objectives.push("3. Garantir des performances optimales même en conditions d'utilisation intensive");
                objectives.push("4. Minimiser les temps de chargement et de traitement des données");
            }
            
            if (description.toLowerCase().includes('sécurité') || description.toLowerCase().includes('données') || 
                description.toLowerCase().includes('confidentialité')) {
                objectives.push("3. Assurer la sécurité des données et la confidentialité des informations utilisateurs");
                objectives.push("4. Mettre en place des mécanismes robustes de protection contre les vulnérabilités");
            }
            
            if (description.toLowerCase().includes('mobile') || description.toLowerCase().includes('smartphone') || 
                description.toLowerCase().includes('tablette')) {
                objectives.push("3. Développer une solution parfaitement adaptée aux appareils mobiles");
                objectives.push("4. Garantir une expérience cohérente sur différentes tailles d'écran");
            }
            
            // Add general project management objectives
            objectives.push("5. Respecter les délais de livraison fixés dans le calendrier du projet");
            objectives.push("6. Établir une communication efficace entre toutes les parties prenantes");
            
            return objectives.join('\n\n');
        }
        
        function generateRequirements(projectName, description) {
            const requirements = ["Exigences fonctionnelles principales:"];
            
            // Extract key concepts from the description
            const domains = [
                {keywords: ['web', 'site', 'internet'], domain: 'web'},
                {keywords: ['mobile', 'app', 'android', 'ios'], domain: 'mobile'},
                {keywords: ['données', 'database', 'stockage'], domain: 'data'},
                {keywords: ['sécurité', 'authentification', 'login'], domain: 'security'},
                {keywords: ['paiement', 'transaction', 'achat'], domain: 'payment'},
                {keywords: ['analytique', 'statistique', 'rapport'], domain: 'analytics'},
                {keywords: ['social', 'réseau', 'partage'], domain: 'social'}
            ];
            
            // Determine the primary domain of the project
            const detectedDomains = [];
            domains.forEach(domain => {
                if (domain.keywords.some(keyword => description.toLowerCase().includes(keyword))) {
                    detectedDomains.push(domain.domain);
                }
            });
            
            // Generate domain-specific requirements
            if (detectedDomains.includes('web')) {
                requirements.push("1. Le site doit être compatible avec les navigateurs modernes (Chrome, Firefox, Safari, Edge)");
                requirements.push("2. L'interface utilisateur doit être responsive et s'adapter à différentes tailles d'écran");
                requirements.push("3. Les temps de chargement des pages doivent être optimisés (< 3 secondes)");
            }
            
            if (detectedDomains.includes('mobile')) {
                requirements.push("1. L'application doit fonctionner sur les plateformes iOS et Android");
                requirements.push("2. L'interface doit s'adapter aux différentes tailles d'écrans mobiles");
                requirements.push("3. L'application doit gérer les états offline et la synchronisation des données");
            }
            
            if (detectedDomains.includes('data')) {
                requirements.push("1. Le système doit permettre le stockage sécurisé des données utilisateurs");
                requirements.push("2. Des mécanismes de sauvegarde et restauration doivent être implémentés");
                requirements.push("3. Les performances des requêtes de données doivent être optimisées");
            }
            
            if (detectedDomains.includes('security')) {
                requirements.push("1. Le système doit implémenter une authentification sécurisée des utilisateurs");
                requirements.push("2. Les données sensibles doivent être cryptées en transit et au repos");
                requirements.push("3. Un système de gestion des droits d'accès doit être mis en place");
            }
            
            // If no specific domain is detected, generate generic requirements
            if (detectedDomains.length === 0) {
                requirements.push("1. Le système doit permettre la création et la gestion de comptes utilisateurs");
                requirements.push("2. Les utilisateurs doivent pouvoir accéder à leurs données personnelles");
                requirements.push("3. L'interface doit être intuitive et facile à prendre en main");
                requirements.push("4. Le système doit être disponible à 99,9% du temps");
            }
            
            // Add generic requirement for all projects
            requirements.push("\nExigences non-fonctionnelles:");
            requirements.push("1. Sécurité: Protection des données utilisateurs conformément aux réglementations en vigueur");
            requirements.push("2. Performance: Temps de réponse rapides même en période de forte charge");
            requirements.push("3. Maintenabilité: Code documenté et structure facilitant les évolutions futures");
            requirements.push("4. Accessibilité: Respect des standards WCAG pour l'accès aux personnes en situation de handicap");
            
            return requirements.join('\n\n');
        }
        
        function generateConstraints(projectName, description) {
            const constraints = ["Contraintes techniques:"];
            
            // Standard constraints for all projects
            constraints.push("1. Compatibilité navigateurs: Le système doit fonctionner sur les versions récentes des navigateurs principaux");
            constraints.push("2. Performance: Temps de réponse inférieur à 3 secondes pour les opérations standards");
            constraints.push("3. Disponibilité: Le service doit être accessible 99,9% du temps");
            
            // Add domain-specific constraints based on description
            if (description.toLowerCase().includes('mobile') || description.toLowerCase().includes('android') || 
                description.toLowerCase().includes('ios') || description.toLowerCase().includes('app')) {
                constraints.push("4. Support multi-plateformes: Compatibilité avec Android 8+ et iOS 12+");
                constraints.push("5. Utilisation hors ligne: Les fonctionnalités essentielles doivent être accessibles sans connexion internet");
            }
            
            if (description.toLowerCase().includes('données') || description.toLowerCase().includes('database') || 
                description.toLowerCase().includes('utilisateur')) {
                constraints.push("4. Protection des données: Conformité au RGPD et autres réglementations applicables");
                constraints.push("5. Sauvegarde: Système de backup quotidien avec rétention de 30 jours minimum");
            }
            
            if (description.toLowerCase().includes('sécurité') || description.toLowerCase().includes('confidentialité')) {
                constraints.push("4. Sécurité: Utilisation du protocole HTTPS et chiffrement des données sensibles");
                constraints.push("5. Authentification: Support de l'authentification à deux facteurs");
            }
            
            // Add constraints regarding integration if relevant
            if (description.toLowerCase().includes('api') || description.toLowerCase().includes('intégration')) {
                constraints.push("4. API: Documentation complète des endpoints et respect des standards RESTful");
                constraints.push("5. Interopérabilité: Capacité à s'intégrer avec les systèmes existants");
            }
            
            // Add hosting/infrastructure constraints
            constraints.push("\nContraintes d'infrastructure:");
            constraints.push("1. Le système doit être déployable sur les environnements cloud standards");
            constraints.push("2. L'architecture doit permettre la mise à l'échelle horizontale en fonction de la charge");
            
            return constraints.join('\n\n');
        }
        
        function generateDeliverables(projectName, description) {
            const deliverables = ["Livrables attendus:"];
            
            // Documentation deliverables - standard for all projects
            deliverables.push("1. Documentation:");
            deliverables.push("   - Cahier des charges validé");
            deliverables.push("   - Documentation technique complète");
            deliverables.push("   - Manuel utilisateur");
            deliverables.push("   - Guide d'installation et de déploiement");
            
            // Source code and development deliverables
            deliverables.push("\n2. Code et développement:");
            deliverables.push("   - Code source complet et commenté");
            deliverables.push("   - Scripts de création et migration de base de données");
            deliverables.push("   - Tests unitaires et d'intégration");
            
            // Add specific deliverables based on project type
            if (description.toLowerCase().includes('web') || description.toLowerCase().includes('site')) {
                deliverables.push("\n3. Solution web:");
                deliverables.push("   - Application web responsive et fonctionnelle");
                deliverables.push("   - Fichiers sources des maquettes et designs");
                deliverables.push("   - Optimisations SEO et analytics");
            }
            
            if (description.toLowerCase().includes('mobile') || description.toLowerCase().includes('app')) {
                deliverables.push("\n3. Application mobile:");
                deliverables.push("   - Applications compilées pour Android et iOS");
                deliverables.push("   - Assets graphiques et ressources");
                deliverables.push("   - Configuration des stores (Play Store, App Store)");
            }
            
            if (description.toLowerCase().includes('api') || description.toLowerCase().includes('backend')) {
                deliverables.push("\n3. Backend et API:");
                deliverables.push("   - API fonctionnelle et sécurisée");
                deliverables.push("   - Documentation Swagger/OpenAPI");
                deliverables.push("   - Collection Postman pour tester les endpoints");
            }
            
            // Training and handover deliverables
            deliverables.push("\n4. Formation et transfert:");
            deliverables.push("   - Session de formation pour les administrateurs");
            deliverables.push("   - Session de formation pour les utilisateurs finaux");
            deliverables.push("   - Période de support post-livraison (30 jours)");
            
            return deliverables.join('\n');
        }
        
        function generateTimeline(projectName, description) {
            const today = new Date();
            const complexityFactor = getProjectComplexity(description);
            let currentMonth = today.getMonth();
            const year = today.getFullYear();
            
            // Calculate realistic phase durations based on complexity
            const phaseDurations = {
                analysis: Math.max(1, Math.floor(complexityFactor * 0.5)),
                design: Math.max(1, Math.floor(complexityFactor * 0.7)),
                development: Math.max(2, Math.floor(complexityFactor * 1.5)),
                testing: Math.max(1, Math.floor(complexityFactor * 0.8)),
                deployment: 1,
                support: 1
            };
            
            const timeline = ["Calendrier prévisionnel:"];
            
            // Analysis phase
            timeline.push(`1. Phase d'analyse et de spécification: ${formatDateRange(currentMonth, phaseDurations.analysis, year)}`);
            currentMonth += phaseDurations.analysis;
            
            // Design phase
            timeline.push(`2. Phase de conception: ${formatDateRange(currentMonth, phaseDurations.design, year)}`);
            currentMonth += phaseDurations.design;
            
            // Development phase
            timeline.push(`3. Phase de développement: ${formatDateRange(currentMonth, phaseDurations.development, year)}`);
            currentMonth += phaseDurations.development;
            
            // Testing phase
            timeline.push(`4. Phase de tests et de validation: ${formatDateRange(currentMonth, phaseDurations.testing, year)}`);
            currentMonth += phaseDurations.testing;
            
            // Deployment phase
            timeline.push(`5. Phase de déploiement: ${formatDateRange(currentMonth, phaseDurations.deployment, year)}`);
            currentMonth += phaseDurations.deployment;
            
            // Support phase
            timeline.push(`6. Phase de support post-lancement: ${formatDateRange(currentMonth, phaseDurations.support, year)}`);
            
            // Add key milestones
            timeline.push("\nJalons clés:");
            
            // Calculate milestone dates based on the phases
            let milestoneMonth = today.getMonth();
            timeline.push(`• Validation du cahier des charges: ${formatMonth(milestoneMonth + phaseDurations.analysis)} ${year}`);
            milestoneMonth += phaseDurations.analysis + phaseDurations.design;
            timeline.push(`• Validation des maquettes/prototypes: ${formatMonth(milestoneMonth)} ${year}`);
            milestoneMonth += Math.floor(phaseDurations.development / 2);
            timeline.push(`• Livraison de la première version testable: ${formatMonth(milestoneMonth)} ${year}`);
            milestoneMonth = today.getMonth() + phaseDurations.analysis + phaseDurations.design + phaseDurations.development;
            timeline.push(`• Recette utilisateur: ${formatMonth(milestoneMonth)} ${year}`);
            milestoneMonth += phaseDurations.testing;
            timeline.push(`• Mise en production: ${formatMonth(milestoneMonth)} ${year}`);
            
            return timeline.join('\n\n');
        }
        
        function getProjectComplexity(description) {
            // Default complexity factor (medium project)
            let complexity = 3;
            
            // Increase complexity based on keywords
            const complexityIndicators = [
                {keywords: ['complexe', 'grande échelle', 'enterprise'], factor: 1},
                {keywords: ['sécurité', 'haute disponibilité', 'performance'], factor: 0.5},
                {keywords: ['mobile', 'web', 'api', 'backend', 'frontend'], factor: 0.3},
                {keywords: ['reporting', 'analytics', 'data', 'ia', 'machine learning'], factor: 0.7},
                {keywords: ['paiement', 'transaction', 'e-commerce'], factor: 0.5}
            ];
            
            // Analyze description for complexity indicators
            complexityIndicators.forEach(indicator => {
                if (indicator.keywords.some(keyword => description.toLowerCase().includes(keyword))) {
                    complexity += indicator.factor;
                }
            });
            
            // Decrease complexity based on simplicity indicators
            const simplicityIndicators = [
                {keywords: ['simple', 'basique', 'prototype'], factor: 1},
                {keywords: ['mvp', 'minimum viable product'], factor: 0.5}
            ];
            
            simplicityIndicators.forEach(indicator => {
                if (indicator.keywords.some(keyword => description.toLowerCase().includes(keyword))) {
                    complexity -= indicator.factor;
                }
            });
            
            // Ensure complexity is at least 2
            return Math.max(2, complexity);
        }
        
        function formatDateRange(startMonth, duration, year) {
            const start = formatMonth(startMonth);
            const end = formatMonth(startMonth + duration - 1);
            return `${start} - ${end} ${year}`;
        }
        
        function formatMonth(monthIndex) {
            const months = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];
            
            // Handle year overflow
            return months[((monthIndex % 12) + 12) % 12];
        }
        
        function extractKeywords(text) {
            // If description is empty, return default actions
            if (!text) return ['gérer les informations', 'consulter les données', 'exporter les résultats', 'analyser les métriques'];
            
            // Define word categories for extraction
            const categories = {
                nouns: ['utilisateur', 'donnée', 'système', 'information', 'résultat', 'projet', 'fonction', 'interface', 
                        'application', 'service', 'profil', 'compte', 'produit', 'paramètre', 'statistique', 'rapport', 
                        'document', 'message', 'notification', 'configuration', 'dashboard', 'module'],
                verbs: ['créer', 'gérer', 'consulter', 'modifier', 'supprimer', 'visualiser', 'analyser', 'exporter', 
                       'importer', 'configurer', 'automatiser', 'synchroniser', 'valider', 'associer', 'filtrer', 
                       'rechercher', 'partager', 'télécharger', 'enregistrer', 'notifier']
            };
            
            const words = text.toLowerCase().split(/\s+/);
            const actionWords = [];
            
            // First pass: find direct matches in text
            words.forEach(word => {
                categories.nouns.forEach(noun => {
                    if (word.includes(noun)) {
                        // Pick a random relevant verb for this noun
                        const relevantVerbs = getRelevantVerbsForNoun(noun);
                        const verb = relevantVerbs[Math.floor(Math.random() * relevantVerbs.length)];
                        actionWords.push(`${verb} les ${pluralize(noun)}`);
                    }
                });
            });
            
            // Second pass: add context-specific actions
            if (text.toLowerCase().includes('utilisateur') || text.toLowerCase().includes('user')) {
                actionWords.push('gérer les comptes utilisateurs');
                actionWords.push('configurer les droits d\'accès');
            }
            
            if (text.toLowerCase().includes('donnée') || text.toLowerCase().includes('data')) {
                actionWords.push('consulter les données en temps réel');
                actionWords.push('exporter les données en différents formats');
            }
            
            if (text.toLowerCase().includes('rapport') || text.toLowerCase().includes('statistique')) {
                actionWords.push('générer des rapports personnalisés');
                actionWords.push('visualiser les statistiques clés');
            }
            
            // Add some default ones if we found few
            if (actionWords.length < 3) {
                actionWords.push('gérer les paramètres du système');
                actionWords.push('consulter le tableau de bord');
                actionWords.push('exporter les résultats');
                actionWords.push('configurer les notifications');
            }
            
            return [...new Set(actionWords)]; // Remove duplicates
        }
        
        function getRelevantVerbsForNoun(noun) {
            // Map common nouns to relevant verbs
            const verbMap = {
                'utilisateur': ['créer', 'gérer', 'modifier', 'supprimer'],
                'donnée': ['consulter', 'analyser', 'exporter', 'filtrer'],
                'information': ['visualiser', 'vérifier', 'mettre à jour'],
                'résultat': ['exporter', 'analyser', 'partager'],
                'interface': ['personnaliser', 'configurer'],
                'rapport': ['générer', 'télécharger', 'partager'],
                'message': ['envoyer', 'recevoir', 'archiver'],
                'notification': ['configurer', 'recevoir', 'gérer']
            };
            
            // Return specific verbs for noun if available, otherwise return general verbs
            return verbMap[noun] || ['gérer', 'consulter', 'modifier', 'configurer'];
        }
        
        function pluralize(word) {
            // Simple pluralization for French words
            if (word.endsWith('eau')) return word + 'x';
            if (word.endsWith('al')) return word.slice(0, -2) + 'aux';
            if (word.endsWith('s') || word.endsWith('x') || word.endsWith('z')) return word;
            return word + 's';
        }
        
        // Handle save button click
        document.getElementById('saveSpecification').addEventListener('click', function() {
            const form = document.getElementById('specificationForm');
            
            // Validate required fields
            const title = document.getElementById('specTitle').value;
            const project = document.getElementById('specProject').value;
            
            if (!title || !project) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }
            
            // Create FormData object to handle file upload
            const formData = new FormData(form);
            
            // Submit form using AJAX
            fetch(form.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message and close modal
                    alert(data.message);
                    $('#newSpecificationModal').modal('hide');
                    
                    // Reload page to show the new specification in the list
                    window.location.reload();
                } else {
                    alert('Erreur: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur est survenue lors de l\'enregistrement.');
            });
        });
        
        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-spec-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Êtes-vous sûr de vouloir supprimer ce cahier des charges ?')) {
                    const specId = this.getAttribute('data-spec-id');
                    
                    fetch(`/delete_specification/${specId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            // Recharger la page pour refléter la suppression
                            window.location.reload();
                        } else {
                            alert('Erreur: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur est survenue lors de la suppression.');
                    });
                }
            });
        });
    });
</script>
{% endblock %}