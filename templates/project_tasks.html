<div class="tab-pane fade show active" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Tâches du projet</h3>
        {% if is_project_admin %}
        <div>
            <button type="button" class="btn btn-success me-2" id="generateTasksAIBtn" onclick="generateTasksWithAI()">
                <i class="material-icons-outlined">psychology</i> Générer des tâches avec IA
            </button>
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newTaskModal" onclick="setTaskStatus('TODO')">
                <i class="material-icons-outlined">add</i> Nouvelle tâche
            </button>
        </div>
        {% endif %}
    </div>
    <div class="kanban-container mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="kanban-column">
                    <h5 class="kanban-title bg-light p-2">À Faire</h5>
                    <div class="kanban-items" id="todo-tasks" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="TODO">
                        {% for task in tasks %}
                            {% if task.status == 'TODO' %}
                            {% set is_assigned = false %}
                            {% for user in task.assigned_users %}
                                {% if user.user_id == current_user_id %}
                                    {% set is_assigned = true %}
                                {% endif %}
                            {% endfor %}
                            <div class="kanban-item" 
                                 draggable="{% if is_project_admin or is_assigned %}true{% else %}false{% endif %}" 
                                 ondragstart="drag(event)" 
                                 id="task-{{ task.task_id }}" 
                                 data-task-id="{{ task.task_id }}">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ task.title }}</h6>
                                        <p class="card-text small">{{ task.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">{{ task.priority }}</span>
                                            <div class="task-users">
                                                {% for user in task.assigned_users %}
                                                    <span class="user-initials" title="{{ user.name }}">{{ user.name[:1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="task-actions mt-2 text-right">
                                            {% if is_project_admin %}
                                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openAssignModal('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">person_add</i>
                                            </button>
                                            {% endif %}
                                            {% if is_project_admin or is_assigned %}
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">edit</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kanban-column">
                    <h5 class="kanban-title bg-light p-2">En cours</h5>
                    <div class="kanban-items" id="in-progress-tasks" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="IN_PROGRESS">
                        {% for task in tasks %}
                            {% if task.status == 'IN_PROGRESS' %}
                            {% set is_assigned = false %}
                            {% for user in task.assigned_users %}
                                {% if user.user_id == current_user_id %}
                                    {% set is_assigned = true %}
                                {% endif %}
                            {% endfor %}
                            <div class="kanban-item" 
                                 draggable="{% if is_project_admin or is_assigned %}true{% else %}false{% endif %}" 
                                 ondragstart="drag(event)" 
                                 id="task-{{ task.task_id }}" 
                                 data-task-id="{{ task.task_id }}">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ task.title }}</h6>
                                        <p class="card-text small">{{ task.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">{{ task.priority }}</span>
                                            <div class="task-users">
                                                {% for user in task.assigned_users %}
                                                    <span class="user-initials" title="{{ user.name }}">{{ user.name[:1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="task-actions mt-2 text-right">
                                            {% if is_project_admin %}
                                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openAssignModal('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">person_add</i>
                                            </button>
                                            {% endif %}
                                            {% if is_project_admin or is_assigned %}
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">edit</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kanban-column">
                    <h5 class="kanban-title bg-light p-2">En révision</h5>
                    <div class="kanban-items" id="review-tasks" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="REVIEW">
                        {% for task in tasks %}
                            {% if task.status == 'REVIEW' %}
                            {% set is_assigned = false %}
                            {% for user in task.assigned_users %}
                                {% if user.user_id == current_user_id %}
                                    {% set is_assigned = true %}
                                {% endif %}
                            {% endfor %}
                            <div class="kanban-item" 
                                 draggable="{% if is_project_admin or is_assigned %}true{% else %}false{% endif %}" 
                                 ondragstart="drag(event)" 
                                 id="task-{{ task.task_id }}" 
                                 data-task-id="{{ task.task_id }}">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ task.title }}</h6>
                                        <p class="card-text small">{{ task.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">{{ task.priority }}</span>
                                            <div class="task-users">
                                                {% for user in task.assigned_users %}
                                                    <span class="user-initials" title="{{ user.name }}">{{ user.name[:1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="task-actions mt-2 text-right">
                                            {% if is_project_admin %}
                                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openAssignModal('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">person_add</i>
                                            </button>
                                            {% endif %}
                                            {% if is_project_admin or is_assigned %}
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">edit</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kanban-column">
                    <h5 class="kanban-title bg-light p-2">Terminé</h5>
                    <div class="kanban-items" id="done-tasks" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="DONE">
                        {% for task in tasks %}
                            {% if task.status == 'DONE' %}
                            {% set is_assigned = false %}
                            {% for user in task.assigned_users %}
                                {% if user.user_id == current_user_id %}
                                    {% set is_assigned = true %}
                                {% endif %}
                            {% endfor %}
                            <div class="kanban-item" 
                                 draggable="{% if is_project_admin or is_assigned %}true{% else %}false{% endif %}" 
                                 ondragstart="drag(event)" 
                                 id="task-{{ task.task_id }}" 
                                 data-task-id="{{ task.task_id }}">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ task.title }}</h6>
                                        <p class="card-text small">{{ task.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">{{ task.priority }}</span>
                                            <div class="task-users">
                                                {% for user in task.assigned_users %}
                                                    <span class="user-initials" title="{{ user.name }}">{{ user.name[:1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="task-actions mt-2 text-right">
                                            {% if is_project_admin %}
                                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openAssignModal('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">person_add</i>
                                            </button>
                                            {% endif %}
                                            {% if is_project_admin or is_assigned %}
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">edit</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .kanban-container {
        overflow-x: auto;
    }
    
    .kanban-column {
        background-color: #f8f9fa;
        border-radius: 4px;
        min-height: 500px;
        height: 100%;
    }
    
    .kanban-title {
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        text-align: center;
        font-weight: 600;
    }
    
    .kanban-items {
        min-height: 400px;
        padding: 10px;
    }
    
    .kanban-item {
        cursor: grab;
    }
    
    .kanban-item:active {
        cursor: grabbing;
    }
    
    .task-users {
        display: flex;
    }
    
    .user-initials {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: -5px;
        font-size: 12px;
    }
    
    .user-initials:first-child {
        margin-left: 0;
    }

    /* Add style for AI button */
    .btn-success {
        margin-right: 10px;
    }

    /* Fix for material icons in buttons */
    .material-icons-outlined {
        vertical-align: middle;
        font-size: 18px;
        margin-right: 4px;
    }
</style>

<script>
    function allowDrop(ev) {
        // Check if the item being dragged is draggable based on permissions
        const draggedItemId = ev.dataTransfer.getData("text");
        const draggedElement = document.getElementById(draggedItemId);
        if (draggedElement && draggedElement.getAttribute('draggable') === 'true') {
            ev.preventDefault();
        }
    }

    function drag(ev) {
        // Only allow drag if the element is draggable
        if (ev.target.getAttribute('draggable') === 'true') {
            ev.dataTransfer.setData("text", ev.target.id);
        } else {
            ev.preventDefault(); // Prevent dragging if not allowed
        }
    }

    function drop(ev) {
        ev.preventDefault();
        const taskId = ev.dataTransfer.getData("text");
        const taskElement = document.getElementById(taskId);
        const targetColumn = ev.target.closest('.kanban-items');
        
        if (targetColumn) {
            targetColumn.appendChild(taskElement);
            
            // Get status from target column
            const newStatus = targetColumn.dataset.status;
            // Get task ID from the task element
            const taskDataId = taskElement.getAttribute('data-task-id');
            
            console.log(`Updating task ${taskDataId} to status ${newStatus}`);
            
            // Send AJAX request to update task status
            updateTaskStatus(taskDataId, newStatus);
        }
    }

    function updateTaskStatus(taskId, newStatus) {
        // Add visual indicator that update is in progress
        const taskElement = document.getElementById(`task-${taskId}`);
        if (taskElement) {
            taskElement.style.opacity = "0.6"; // Dim the card to indicate processing
        }

        fetch('/update_task_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task_id: taskId,
                status: newStatus
            }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log(`Task ${taskId} status updated successfully to ${newStatus}`);
                
                // Reset opacity
                if (taskElement) {
                    taskElement.style.opacity = "1";
                }
            } else {
                console.error(`Failed to update task status: ${data.message}`);
                alert(`Erreur lors de la mise à jour du statut: ${data.message}`);
                // Restore UI to original state or reload the page
                location.reload(); 
            }
        })
        .catch(error => {
            console.error('Error updating task status:', error);
            alert('Une erreur est survenue lors de la mise à jour du statut de la tâche.');
            // Restore UI to original state or reload the page
            location.reload();
        });
    }

    function deleteTask(taskId) {
        event.stopPropagation(); // Important to prevent other card events
        if (!confirm('Êtes-vous sûr de vouloir supprimer cette tâche ? Cette action est irréversible.')) {
            return;
        }

        fetch(`/delete_task/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // If you use CSRF tokens, ensure they are included here
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    taskElement.remove();
                } else {
                    // Fallback if the element isn't found (e.g., ID structure changed)
                    // or if you prefer a full refresh to ensure UI consistency
                    location.reload();
                }
                // You could add a more sophisticated notification here (e.g., a toast)
                console.log('Task deleted successfully');
            } else {
                alert('Erreur lors de la suppression de la tâche: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting task:', error);
            alert('Une erreur s\'est produite lors de la suppression de la tâche.');
        });
    }

    function generateTasksWithAI() {
        // Show modal with loading state
        $('#ai-tasks-loading').show();
        $('#ai-tasks-container').hide();
        $('#ai-tasks-error').hide();
        $('#addSelectedTasksBtn').hide();
        $('#aiGeneratedTasksModal').modal('show');
        
        // Make API call to generate tasks
        fetch(`/generate_tasks_for_project/{{ project.project_id }}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.tasks && data.tasks.length > 0) {
                    // Show generated tasks
                    displayGeneratedTasks(data.tasks);
                } else {
                    throw new Error(data.message || 'Aucune tâche générée');
                }
            })
            .catch(error => {
                console.error('Error generating tasks:', error);
                $('#ai-tasks-loading').hide();
                $('#ai-tasks-error').text(`Erreur: ${error.message || 'Impossible de générer des tâches.'}`).show();
            });
    }

    function displayGeneratedTasks(tasks) {
        const tasksContainer = document.getElementById('ai-tasks-list');
        tasksContainer.innerHTML = '';
        
        tasks.forEach((task, index) => {
            const taskElement = document.createElement('div');
            taskElement.className = 'card mb-3';
            taskElement.innerHTML = `
                <div class="card-header">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input task-checkbox" id="task-${index}" checked>
                        <label class="custom-control-label font-weight-bold" for="task-${index}">${task.title}</label>
                    </div>
                </div>
                <div class="card-body">
                    <p>${task.description}</p>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge ${getPriorityBadgeClass(task.priority)}">${task.priority}</span>
                        <span>
                            ${task.start_date ? `<i class="material-icons-outlined" style="font-size:16px;vertical-align:middle;">event</i> ${task.start_date}` : ''}
                            ${task.end_date ? ` &rarr; ${task.end_date}` : ''}
                        </span>
                    </div>
                </div>
            `;
            tasksContainer.appendChild(taskElement);
        });
        
        // Store tasks in a global variable for later use
        window.generatedTasks = tasks;
        
        // Hide loading, show content and add button
        $('#ai-tasks-loading').hide();
        $('#ai-tasks-container').show();
        $('#addSelectedTasksBtn').show();
    }

    function getPriorityBadgeClass(priority) {
        switch(priority.toLowerCase()) {
            case 'high': return 'bg-danger';
            case 'medium': return 'bg-warning';
            case 'low': return 'bg-info';
            default: return 'bg-secondary';
        }
    }

    function addSelectedTasks() {
        if (!window.generatedTasks) return;
        
        const selectedTasks = [];
        const checkboxes = document.querySelectorAll('.task-checkbox');
        
        checkboxes.forEach((checkbox, index) => {
            if (checkbox.checked && window.generatedTasks[index]) {
                selectedTasks.push(window.generatedTasks[index]);
            }
        });
        
        if (selectedTasks.length === 0) {
            alert('Veuillez sélectionner au moins une tâche à ajouter.');
            return;
        }
        
        // Show loading state
        $('#addSelectedTasksBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ajout en cours...');
        
        // Counter for tracking task creation progress
        let completedTasks = 0;
        let failedTasks = 0;
        
        // Process each selected task
        selectedTasks.forEach(task => {
            // Create the task via API
            fetch('/add_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: task.title,
                    description: task.description,
                    priority: task.priority.toLowerCase(),
                    status: 'TODO',
                    project_id: "{{ project.project_id }}",
                    start_date: task.start_date || null,
                    end_date: task.end_date || null
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    completedTasks++;
                } else {
                    failedTasks++;
                    console.error('Failed to create task:', data.message);
                }
            })
            .catch(error => {
                failedTasks++;
                console.error('Error creating task:', error);
            })
            .finally(() => {
                // Check if all tasks have been processed
                if (completedTasks + failedTasks === selectedTasks.length) {
                    if (failedTasks > 0) {
                        alert(`${completedTasks} tâches ajoutées avec succès. ${failedTasks} tâches n'ont pas pu être ajoutées.`);
                    }
                    // Close modal and reload page to show new tasks
                    $('#aiGeneratedTasksModal').modal('hide');
                    location.reload();
                }
            });
        });
    }

    const projectParticipants = {{ participants | tojson }};

    let taskStatus = 'TODO';

    function setTaskStatus(status) {
        taskStatus = status;
    }

    function createTask() {
        const title = document.getElementById('taskTitle').value;
        const description = document.getElementById('taskDescription').value;
        const priority = document.getElementById('taskPriority').value;
        const startDate = document.getElementById('taskStartDate').value;
        const endDate = document.getElementById('taskEndDate').value;

        fetch('/add_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                description: description,
                priority: priority,
                assignee_ids: [], // Empty array since we removed the field
                start_date: startDate,
                end_date: endDate,
                status: taskStatus,
                project_id: "{{ project.project_id }}"
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#newTaskModal').modal('hide');
                location.reload(); // Reload to see the new task with assignees
            } else {
                alert('Failed to create task: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create task');
        });
    }
</script>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1" role="dialog" aria-labelledby="newTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newTaskModalLabel">Créer une nouvelle tâche</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#newTaskModal').modal('hide')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newTaskForm">
                    <div class="form-group">
                        <label for="taskTitle">Titre de la tâche</label>
                        <input type="text" class="form-control" id="taskTitle" placeholder="Entrez le titre de la tâche">
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3" placeholder="Entrez la description de la tâche"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Priorité</label>
                        <select class="form-control" id="taskPriority">
                            <option>low</option>
                            <option>medium</option>
                            <option>high</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskStartDate">Date de début</label>
                        <input type="date" class="form-control" id="taskStartDate" placeholder="dd/mm/yyyy">
                    </div>
                    <div class="form-group">
                        <label for="taskEndDate">Date de fin</label>
                        <input type="date" class="form-control" id="taskEndDate" placeholder="dd/mm/yyyy">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="$('#newTaskModal').modal('hide')">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="createTask()">Créer la tâche</button>
            </div>
        </div>
    </div>
</div>
