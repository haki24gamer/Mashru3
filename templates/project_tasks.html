<div class="tab-pane fade show active" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Tâches du projet</h3>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newTaskModal" onclick="setTaskStatus('TODO')">
            <i class="material-icons-outlined">add</i> Nouvelle tâche
        </button>
    </div>
    <div class="kanban-container mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="kanban-column">
                    <h5 class="kanban-title bg-light p-2">À Faire</h5>
                    <div class="kanban-items" id="todo-tasks" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="TODO">
                        {% for task in tasks %}
                            {% if task.status == 'TODO' %}
                            <div class="kanban-item" draggable="true" ondragstart="drag(event)" id="task-{{ task.task_id }}" data-task-id="{{ task.task_id }}">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ task.title }}</h6>
                                        <p class="card-text small">{{ task.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">{{ task.priority }}</span>
                                            <div class="task-users">
                                                {% for user in task.assigned_users %}
                                                    <span class="user-initials" title="{{ user.name }}">{{ user.name[:1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="task-actions mt-2 text-right">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openAssignModal('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">person_add</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">edit</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kanban-column">
                    <h5 class="kanban-title bg-light p-2">En cours</h5>
                    <div class="kanban-items" id="in-progress-tasks" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="IN_PROGRESS">
                        {% for task in tasks %}
                            {% if task.status == 'IN_PROGRESS' %}
                            <div class="kanban-item" draggable="true" ondragstart="drag(event)" id="task-{{ task.task_id }}" data-task-id="{{ task.task_id }}">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ task.title }}</h6>
                                        <p class="card-text small">{{ task.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">{{ task.priority }}</span>
                                            <div class="task-users">
                                                {% for user in task.assigned_users %}
                                                    <span class="user-initials" title="{{ user.name }}">{{ user.name[:1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="task-actions mt-2 text-right">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openAssignModal('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">person_add</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">edit</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kanban-column">
                    <h5 class="kanban-title bg-light p-2">En révision</h5>
                    <div class="kanban-items" id="review-tasks" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="REVIEW">
                        {% for task in tasks %}
                            {% if task.status == 'REVIEW' %}
                            <div class="kanban-item" draggable="true" ondragstart="drag(event)" id="task-{{ task.task_id }}" data-task-id="{{ task.task_id }}">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ task.title }}</h6>
                                        <p class="card-text small">{{ task.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">{{ task.priority }}</span>
                                            <div class="task-users">
                                                {% for user in task.assigned_users %}
                                                    <span class="user-initials" title="{{ user.name }}">{{ user.name[:1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="task-actions mt-2 text-right">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openAssignModal('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">person_add</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">edit</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kanban-column">
                    <h5 class="kanban-title bg-light p-2">Terminé</h5>
                    <div class="kanban-items" id="done-tasks" ondrop="drop(event)" ondragover="allowDrop(event)" data-status="DONE">
                        {% for task in tasks %}
                            {% if task.status == 'DONE' %}
                            <div class="kanban-item" draggable="true" ondragstart="drag(event)" id="task-{{ task.task_id }}" data-task-id="{{ task.task_id }}">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ task.title }}</h6>
                                        <p class="card-text small">{{ task.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">{{ task.priority }}</span>
                                            <div class="task-users">
                                                {% for user in task.assigned_users %}
                                                    <span class="user-initials" title="{{ user.name }}">{{ user.name[:1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="task-actions mt-2 text-right">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openAssignModal('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">person_add</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">edit</i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask('{{ task.task_id }}');">
                                                <i class="material-icons-outlined" style="font-size: 16px;">delete</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .kanban-container {
        overflow-x: auto;
    }
    
    .kanban-column {
        background-color: #f8f9fa;
        border-radius: 4px;
        min-height: 500px;
        height: 100%;
    }
    
    .kanban-title {
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        text-align: center;
        font-weight: 600;
    }
    
    .kanban-items {
        min-height: 400px;
        padding: 10px;
    }
    
    .kanban-item {
        cursor: grab;
    }
    
    .kanban-item:active {
        cursor: grabbing;
    }
    
    .task-users {
        display: flex;
    }
    
    .user-initials {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: -5px;
        font-size: 12px;
    }
    
    .user-initials:first-child {
        margin-left: 0;
    }
</style>

<script>
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        const taskId = ev.dataTransfer.getData("text");
        const taskElement = document.getElementById(taskId);
        const targetColumn = ev.target.closest('.kanban-items');
        
        if (targetColumn) {
            targetColumn.appendChild(taskElement);
            
            // Get status from target column
            const newStatus = targetColumn.dataset.status;
            // Get task ID from the task element
            const taskDataId = taskElement.getAttribute('data-task-id');
            
            // Send AJAX request to update task status
            updateTaskStatus(taskDataId, newStatus);
        }
    }

    function updateTaskStatus(taskId, newStatus) {
        fetch('/update_task_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task_id: taskId,
                status: newStatus
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Task status updated successfully');
            } else {
                console.error('Failed to update task status');
                // Optionally refresh the page to restore the original state
            }
        })
        .catch(error => {
            console.error('Error updating task status:', error);
        });
    }

    function deleteTask(taskId) {
        event.stopPropagation(); // Important to prevent other card events
        if (!confirm('Êtes-vous sûr de vouloir supprimer cette tâche ? Cette action est irréversible.')) {
            return;
        }

        fetch(`/delete_task/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // If you use CSRF tokens, ensure they are included here
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    taskElement.remove();
                } else {
                    // Fallback if the element isn't found (e.g., ID structure changed)
                    // or if you prefer a full refresh to ensure UI consistency
                    location.reload();
                }
                // You could add a more sophisticated notification here (e.g., a toast)
                console.log('Task deleted successfully');
            } else {
                alert('Erreur lors de la suppression de la tâche: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting task:', error);
            alert('Une erreur s\'est produite lors de la suppression de la tâche.');
        });
    }
</script>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1" role="dialog" aria-labelledby="newTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newTaskModalLabel">Créer une nouvelle tâche</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newTaskForm">
                    <div class="form-group">
                        <label for="taskTitle">Titre de la tâche</label>
                        <input type="text" class="form-control" id="taskTitle" placeholder="Entrez le titre de la tâche">
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3" placeholder="Entrez la description de la tâche"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Priorité</label>
                        <select class="form-control" id="taskPriority">
                            <option>low</option>
                            <option>medium</option>
                            <option>high</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskStartDate">Date de début</label>
                        <input type="date" class="form-control" id="taskStartDate" placeholder="dd/mm/yyyy">
                    </div>
                    <div class="form-group">
                        <label for="taskEndDate">Date de fin</label>
                        <input type="date" class="form-control" id="taskEndDate" placeholder="dd/mm/yyyy">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="createTask()">Créer la tâche</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign User Modal -->
<div class="modal fade" id="assignUserModal" tabindex="-1" role="dialog" aria-labelledby="assignUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignUserModalLabel">Assigner/Désassigner des utilisateurs</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="participant-list">
                    <p class="text-center text-muted">Chargement des participants...</p>
                </div>
                <input type="hidden" id="assign_task_id" name="task_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Modifier la tâche</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="form-group">
                        <label for="editTaskTitle">Titre de la tâche</label>
                        <input type="text" class="form-control" id="editTaskTitle" placeholder="Entrez le titre de la tâche">
                    </div>
                    <div class="form-group">
                        <label for="editTaskDescription">Description</label>
                        <textarea class="form-control" id="editTaskDescription" rows="3" placeholder="Entrez la description de la tâche"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTaskPriority">Priorité</label>
                        <select class="form-control" id="editTaskPriority">
                            <option value="low">low</option>
                            <option value="medium">medium</option>
                            <option value="high">high</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTaskStartDate">Date de début</label>
                        <input type="date" class="form-control" id="editTaskStartDate">
                    </div>
                    <div class="form-group">
                        <label for="editTaskEndDate">Date de fin</label>
                        <input type="date" class="form-control" id="editTaskEndDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="updateTask()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<script>
const projectParticipants = {{ participants | tojson }};

let taskStatus = 'TODO';

function setTaskStatus(status) {
    taskStatus = status;
}

async function openAssignModal(taskId) {
    document.getElementById('assign_task_id').value = taskId;
    const participantListDiv = document.getElementById('participant-list');
    participantListDiv.innerHTML = '<p class="text-center text-muted">Chargement...</p>';

    try {
        const response = await fetch(`/get_task_assignees/${taskId}`);
        const data = await response.json();

        if (!data.success) {
            participantListDiv.innerHTML = `<p class="text-danger">Erreur: ${data.message}</p>`;
            $('#assignUserModal').modal('show');
            return;
        }

        const currentAssigneeIds = new Set(data.assignee_ids);
        participantListDiv.innerHTML = '';

        if (projectParticipants.length === 0) {
             participantListDiv.innerHTML = '<p class="text-center text-muted">Aucun participant dans ce projet.</p>';
        }

        projectParticipants.forEach(participant => {
            const isAssigned = currentAssigneeIds.has(participant.user_id);
            const action = isAssigned ? 'unassign' : 'assign';
            const btnClass = isAssigned ? 'btn-outline-danger' : 'btn-success';
            const btnText = isAssigned ? 'Désassigner' : 'Assigner';

            const itemDiv = document.createElement('div');
            itemDiv.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
            itemDiv.innerHTML = `
                <span>${participant.name} (${participant.email})</span>
                <button type="button" class="btn btn-sm ${btnClass} toggle-assign-btn" data-user-id="${participant.user_id}" data-action="${action}">
                    ${btnText}
                </button>
            `;
            participantListDiv.appendChild(itemDiv);
        });

    } catch (error) {
        console.error('Error fetching or building assignees list:', error);
        participantListDiv.innerHTML = `<p class="text-danger">Erreur lors du chargement des assignations.</p>`;
    } finally {
        $('#assignUserModal').modal('show');
    }
}

document.getElementById('participant-list').addEventListener('click', function(event) {
    if (event.target.classList.contains('toggle-assign-btn')) {
        const button = event.target;
        const currentAction = button.getAttribute('data-action');
        const userId = button.getAttribute('data-user-id');
        const taskId = document.getElementById('assign_task_id').value;

        // Show loading state
        const originalText = button.textContent;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        
        // Call function to update assignment
        toggleUserAssignment(taskId, userId, currentAction === 'assign')
            .then(success => {
                if (success) {
                    // Toggle button state
                    if (currentAction === 'assign') {
                        button.setAttribute('data-action', 'unassign');
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-danger');
                        button.textContent = 'Désassigner';
                    } else {
                        button.setAttribute('data-action', 'assign');
                        button.classList.remove('btn-outline-danger');
                        button.classList.add('btn-success');
                        button.textContent = 'Assigner';
                    }
                    
                    // Update the UI to reflect the change
                    updateTaskUsersDisplay(taskId);
                } else {
                    // Restore original button state on error
                    button.textContent = originalText;
                    alert('Échec de la mise à jour de l\'assignation');
                }
            })
            .finally(() => {
                button.disabled = false;
            });
    }
});

// Function to handle individual user assignments
async function toggleUserAssignment(taskId, userId, isAssigning) {
    const userIds = isAssigning ? [userId] : [];
    
    if (!isAssigning) {
        // For unassignment, we need to get current assignees and remove this user
        try {
            const response = await fetch(`/get_task_assignees/${taskId}`);
            const data = await response.json();
            
            if (data.success) {
                // Filter out the user being unassigned
                userIds.push(...data.assignee_ids.filter(id => id !== parseInt(userId)));
            } else {
                console.error('Failed to get current assignees:', data.message);
                return false;
            }
        } catch (error) {
            console.error('Error fetching current assignees:', error);
            return false;
        }
    }
    
    try {
        const response = await fetch('/update_task_assignments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_ids: userIds,
                task_id: taskId
            })
        });
        
        const data = await response.json();
        return data.success;
    } catch (error) {
        console.error('Error updating assignment:', error);
        return false;
    }
}

// Function to update the task card to reflect new assignees
function updateTaskUsersDisplay(taskId) {
    const taskElement = document.getElementById(`task-${taskId}`);
    if (!taskElement) return;
    
    fetch(`/get_task_assignees/${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Find all users that match the assignee IDs
                const assignedUsers = projectParticipants.filter(
                    participant => data.assignee_ids.includes(participant.user_id)
                );
                
                // Update the UI element showing assigned users
                const usersContainer = taskElement.querySelector('.task-users');
                if (usersContainer) {
                    usersContainer.innerHTML = '';
                    
                    assignedUsers.forEach(user => {
                        const initial = document.createElement('span');
                        initial.className = 'user-initials';
                        initial.title = user.name;
                        initial.textContent = user.name.charAt(0);
                        usersContainer.appendChild(initial);
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error updating task users display:', error);
        });
}

$(document).ready(function(){
    $('[data-toggle="popover"]').popover({
        html: true,
        placement: 'top'
    });
});

function createTask() {
    const title = document.getElementById('taskTitle').value;
    const description = document.getElementById('taskDescription').value;
    const priority = document.getElementById('taskPriority').value;
    const startDate = document.getElementById('taskStartDate').value;
    const endDate = document.getElementById('taskEndDate').value;

    fetch('/add_task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            priority: priority,
            start_date: startDate,
            end_date: endDate,
            status: taskStatus,
            project_id: "{{ project.project_id }}"
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === 'Task created successfully') {
            $('#newTaskModal').modal('hide');
            location.reload();
        } else {
            alert('Failed to create task');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create task');
    });
}

function editTask(taskId) {
    event.stopPropagation();
    
    fetch(`/get_task/${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('editTaskId').value = data.task.task_id;
                document.getElementById('editTaskTitle').value = data.task.title;
                document.getElementById('editTaskDescription').value = data.task.description;
                document.getElementById('editTaskPriority').value = data.task.priority;
                document.getElementById('editTaskStartDate').value = data.task.start_date;
                document.getElementById('editTaskEndDate').value = data.task.end_date;
                
                $('#editTaskModal').modal('show');
            } else {
                alert('Failed to fetch task details');
            }
        })
        .catch(error => {
            console.error('Error fetching task details:', error);
        });
}

function updateTask() {
    const taskId = document.getElementById('editTaskId').value;
    const data = {
        title: document.getElementById('editTaskTitle').value,
        description: document.getElementById('editTaskDescription').value,
        priority: document.getElementById('editTaskPriority').value,
        start_date: document.getElementById('editTaskStartDate').value,
        end_date: document.getElementById('editTaskEndDate').value
    };
    
    fetch(`/update_task/${taskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#editTaskModal').modal('hide');
            location.reload();
        } else {
            alert('Failed to update task: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error updating task:', error);
    });
}
</script>
